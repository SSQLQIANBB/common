name: Auto Publish to NPM

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'
      - 'example/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org/'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Build package
        run: pnpm build
        
      - name: Build types
        run: pnpm build:types
        
      - name: Auto bump version
        id: bump-version
        run: |
          # è·å–å½“å‰NPMä¸Šçš„æœ€æ–°ç‰ˆæœ¬
          if npm view @sycsq/common@latest version > /dev/null 2>&1; then
            npm_version=$(npm view @sycsq/common@latest version)
            echo "npm_version=$npm_version" >> $GITHUB_OUTPUT
            
            # æ¯”è¾ƒç‰ˆæœ¬ï¼Œå¦‚æœç›¸åŒåˆ™å¢åŠ patchç‰ˆæœ¬
            local_version=$(node -p "require('./package.json').version")
            if [ "$npm_version" = "$local_version" ]; then
              node scripts/version.js patch
              new_version=$(node -p "require('./package.json').version")
              echo "version_bumped=true" >> $GITHUB_OUTPUT
              echo "new_version=$new_version" >> $GITHUB_OUTPUT
            else
              echo "version_bumped=false" >> $GITHUB_OUTPUT
              echo "new_version=$local_version" >> $GITHUB_OUTPUT
            fi
          else
            echo "version_bumped=false" >> $GITHUB_OUTPUT
            echo "new_version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          fi
          
      - name: Publish to NPM
        run: pnpm publish --no-git-checks --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Create Release
        if: steps.bump-version.outputs.version_bumped == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump-version.outputs.new_version }}
          release_name: ğŸš€ Release v${{ steps.bump-version.outputs.new_version }}
          body: |
            ## ğŸ‰ è‡ªåŠ¨å‘å¸ƒ
            
            **ç‰ˆæœ¬**: v${{ steps.bump-version.outputs.new_version }}
            **æäº¤**: ${{ github.sha }}
            **æ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ“¦ æ„å»ºå†…å®¹
            - âœ… TypeScript ç¼–è¯‘å®Œæˆ
            - âœ… Vite æ„å»ºå®Œæˆ  
            - âœ… ç±»å‹å£°æ˜ç”Ÿæˆ
            - âœ… NPM å‘å¸ƒæˆåŠŸ
            
            ---
            
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒ*
          draft: false
          prerelease: false 